{% extends "professional/base.html" %}
{% block title %}Profile{% endblock %}
{% block main %}
    {% if current_user.role.name == "PROFESSIONAL" %}
        {% if edit %}
            <div class="container py-4 h-100">
                <div class="row d-flex justify-content-center align-items-top h-100">
                    <div class="col-md-4 d-none d-md-block">
                        <div class="card bg-dark">
                            <div class="card-body">
                                <nav class="nav flex-column nav-pills nav-gap-y-1">
                                    <a href="#profile" data-toggle="tab" class="nav-item nav-link has-icon nav-link-faded active">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-user mr-2">
                                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                            <circle cx="12" cy="7" r="4"></circle>
                                        </svg>
                                        Profile Information
                                    </a>
                                    <a href="#professional" data-toggle="tab" class="nav-item nav-link has-icon nav-link-faded">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-briefcase mr-2">
                                            <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                                            <path d="M16 7V5a2 2 0 0 0-2-2H10a2 2 0 0 0-2 2v2"></path>
                                        </svg>
                                        Professional Information
                                    </a>
                                    <a href="#location" data-toggle="tab" class="nav-item nav-link has-icon nav-link-faded">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-map-pin mr-2">
                                            <path d="M21 10c0 6-9 12-9 12s-9-6-9-12a9 9 0 1 1 18 0z"></path>
                                            <circle cx="12" cy="10" r="3"></circle>
                                        </svg>
                                        Location
                                    </a>
                                    <a href="#security" data-toggle="tab" class="nav-item nav-link has-icon nav-link-faded">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-shield mr-2">
                                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                                        </svg>
                                        Security
                                    </a>
                                </nav>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header border-bottom mb-3 d-flex d-md-none">
                                <ul class="nav nav-tabs card-header-tabs nav-gap-x-1" role="tablist">
                                    <li class="nav-item">
                                        <a href="#profile" data-toggle="tab" class="nav-link has-icon active">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-user">
                                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                                <circle cx="12" cy="7" r="4"></circle>
                                            </svg>
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a href="#professional" data-toggle="tab" class="nav-link has-icon">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-briefcase mr-2">
                                                <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                                                <path d="M16 7V5a2 2 0 0 0-2-2H10a2 2 0 0 0-2 2v2"></path>
                                            </svg>
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a href="#location" data-toggle="tab" class="nav-link has-icon">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-map-pin mr-2">
                                                <path d="M21 10c0 6-9 12-9 12s-9-6-9-12a9 9 0 1 1 18 0z"></path>
                                                <circle cx="12" cy="10" r="3"></circle>
                                            </svg>
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a href="#security" data-toggle="tab" class="nav-link has-icon">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-shield">
                                                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                                            </svg>
                                        </a>
                                    </li>
                                </ul>
                            </div>
                            <div class="card-body tab-content">
                                <div class="tab-pane active" id="profile">
                                    <h6>YOUR PROFILE INFORMATION</h6>
                                    <hr />
                                    <form action="{{ url_for('professional.profile', formx='form_personal') }}" enctype="multipart/form-data" method="POST">
                                        <input type="hidden" name="_method" value="PUT">
                                        {{ form_personal.hidden_tag() }}
                                        <div class="form-group">
                                            {{ form_personal.name.label(class="form-label") }}
                                            {{ form_personal.name(class="form-control", value=current_user.name) }}
                                        </div>
                                        <div class="form-group">
                                            {{ form_personal.email.label(class="form-label") }}
                                            {{ form_personal.email(class="form-control", value=current_user.email) }}
                                        </div>
                                        <div class="form-group">
                                            {{ form_personal.phone.label(class="form-label") }}
                                            {{ form_personal.phone(class="form-control", value=current_user.phone) }}
                                        </div>
                                        <div class="form-group">
                                            {{ form_personal.username.label(class="form-label") }}
                                            {{ form_personal.username(class="form-control", value=current_user.username) }}
                                        </div>
                                        <div class="form-group">
                                            {{ form_personal.about.label(class="form-label") }}
                                            {{ form_personal.about(class="form-control", value=current_user.about) }}
                                        </div>
                                        <div class="form-group">
                                            {{ form_personal.profile_image.label(class="form-label") }}
                                            {{ form_personal.profile_image(class="form-control", accept="image/*") }}
                                            <img id="imagePreview" src="{{ url_for('static', filename='uploads/profile/' ~ current_user.profile_image) }}" alt="Professional Image" style="max-width: 20%; height: auto; margin-top: 1rem">
                                        </div>
                                        <a href="{{ url_for('professional.profile') }}" class="btn btn-secondary">Back</a>
                                        {{ form_personal.submit(class="btn btn-primary") }}
                                    </form>
                                </div>
                                <div class="tab-pane" id="professional">
                                    <h6>YOUR PROFESSIONAL INFORMATION</h6>
                                    <hr />
                                    <form action="{{ url_for('professional.profile', formx='form_service') }}" method="POST">
                                        <input type="hidden" name="_method" value="PUT">
                                        {{ form_service.hidden_tag() }}
                                        <div class="form-group">
                                            {{ form_service.service_price.label(class="form-label") }}
                                            {{ form_service.service_price(class="form-control", value=current_user.professional_data.service_price) }}
                                        </div>
                                        <div class="form-group">
                                            {{ form_service.experience.label(class="form-label") }}
                                            {{ form_service.experience(class="form-control", value=current_user.professional_data.experience) }}
                                        </div>
                                        <a href="{{ url_for('professional.profile') }}" class="btn btn-secondary">Back</a>
                                        {{ form_service.submit(class="btn btn-primary") }}
                                    </form>
                                </div>
                                <div class="tab-pane" id="location">
                                    <h6>LOCATION INFORMATION</h6>
                                    <hr />
                                    <form action="{{ url_for('professional.profile', formx='form_address') }}" method="POST">
                                        <input type="hidden" name="_method" value="PUT">
                                        {{ form_address.hidden_tag() }}
                                        <div class="mb-3">
                                            {{ form_address.address.label(class="form-label") }}
                                            {{ form_address.address(class="form-control") }}
                                        </div>
                                        <div class="mb-3">
                                            {{ form_address.pincode.label(class="form-label", for="pincode-input") }}
                                            <div class="d-flex justify-content-start position-relative">
                                                {{ form_address.pincode(class="form-control", placeholder="Enter pincode", id="pincode-input") }}
                                                <a class="btn btn-primary" id="search-button" onclick="fetchAddresses(document.getElementById('pincode-input').value)"><i class="fas fa-search"></i></a>
                                            </div>
                                        </div>
                                        <div id="address-list" class="list-group" style="display: none;"></div>
                                        <div id="map">
                                            {{ form_address.lat(class="form-control", value=current_user.latitude, id="lat", type="hidden") }}
                                            {{ form_address.lng(class="form-control", value=current_user.longitude, id="lng", type="hidden") }}
                                        </div>
                                        <a href="{{ url_for('professional.profile') }}" class="btn btn-secondary">Back</a>
                                        {{ form_address.submit(class="btn btn-primary") }}
                                        <style>
                                            #map {
                                                height: 400px;
                                                width: 100%;
                                            }

                                            #address-list {
                                                max-height: 200px;
                                                overflow-y: auto;
                                                position: absolute;
                                                background: white;
                                                z-index: 999;
                                                width: 90%;
                                            }
                                        </style>
                                        <!-- Leaflet.js CSS -->
                                        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" integrity="sha512-Zcn6bjR/8RZbLEpLIeOwNtzREBAJnUKESxces60Mpoj+2okopSAcSUIUOseddDm0cxnGQzxIR7vJgsLZbdLE3w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
                                        <!-- Leaflet.js JavaScript -->
                                        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js" integrity="sha512-BwHfrr4c9kmRkLw6iXFdzcdWV/PGkVgiIyIWLLlTSXzWQzxuSg4DiQUCpauz/EWjgk5TYQqX/kvn9pG1NpYfqg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
                                        <script>
                                            document.addEventListener("DOMContentLoaded", function() {
                                                // Initialize the map directly
                                                var map = L.map("map").setView(['{{ current_user.latitude }}', '{{ current_user.longitude }}'], 17); // User's coordinates
                                                var pincodeInput = document.getElementById("pincode-input");
                                                // Add OpenStreetMap tiles
                                                L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                                                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                                                }).addTo(map);

                                                // Add a draggable marker to the map
                                                var marker = L.marker(['{{ current_user.latitude }}', '{{ current_user.longitude }}'], {
                                                    draggable: true
                                                }).addTo(map);

                                                // Update the hidden form fields when the marker is dragged
                                                marker.on("dragend", function() {
                                                    var latLng = marker.getLatLng();
                                                    document.getElementById("lat").value = latLng.lat;
                                                    document.getElementById("lng").value = latLng.lng;
                                                });

                                                pincodeInput.addEventListener("keydown", function(event) {
                                                    if (event.key === "Enter") {
                                                        document.getElementById("search-button").click();
                                                        // Optionally return false to prevent form submission
                                                        event.preventDefault();
                                                    }
                                                });
                                                // Function to fetch addresses from Nominatim
                                                window.fetchAddresses = function(pincode) {
                                                    if (pincode.length === 6) {
                                                        var url = `https://nominatim.openstreetmap.org/search?postalcode=${pincode}&country=India&format=json&addressdetails=1`;
                                                        fetch(url)
                                                            .then((response) => response.json())
                                                            .then((data) => {
                                                                showAddressList(data);
                                                            })
                                                            .catch((error) => console.error("Error fetching addresses:", error));
                                                    } else {
                                                        document.getElementById("address-list").style.display = "none"; // Hide if pincode is not 6 digits
                                                    }
                                                };

                                                // Function to display addresses in a list
                                                window.showAddressList = function(addresses) {
                                                    var addressList = document.getElementById("address-list");
                                                    addressList.innerHTML = ""; // Clear previous results
                                                    if (addresses.length > 0) {
                                                        addresses.forEach((address) => {
                                                            var listItem = document.createElement("a");
                                                            listItem.href = "#";
                                                            listItem.className = "list-group-item list-group-item-action";
                                                            listItem.textContent = address.display_name;
                                                            listItem.onclick = function() {
                                                                selectAddress(address);
                                                                return false; // Prevent default anchor behavior
                                                            };
                                                            addressList.appendChild(listItem);
                                                        });
                                                        addressList.style.display = "block"; // Show the address list
                                                    } else {
                                                        addressList.style.display = "none"; // Hide if no addresses found
                                                    }
                                                };

                                                // Function to select an address and update the map
                                                window.selectAddress = function(address) {
                                                    var latLng = [address.lat, address.lon];
                                                    map.setView(latLng, 15); // Set the map view to the new location
                                                    marker.setLatLng(latLng); // Move the marker to the new location
                                                    document.getElementById("lat").value = address.lat;
                                                    document.getElementById("lng").value = address.lon;
                                                    document.getElementById("address-list").style.display = "none"; // Hide address list after selection
                                                };

                                                // Add an event listener for tab activation
                                                $('a[data-toggle="tab"]').on('shown.bs.tab', function(e) {
                                                    if ($(e.target).attr('href') === '#location') {
                                                        map.invalidateSize(); // Refresh the map size when the tab is shown
                                                    }
                                                });
                                            });
                                        </script>
                                    </form>
                                </div>
                                <div class="tab-pane" id="security">
                                    <h6>SECURITY SETTINGS</h6>
                                    <hr />
                                    <form action="{{ url_for('professional.profile', formx='form_security') }}" method="POST" id="form_security">
                                        <input type="hidden" name="_method" value="PUT">
                                        {{ form_security.hidden_tag() }}
                                        <div class="form-group">
                                            <label class="d-block">Change Password</label>
                                            {{ form_security.current_password(class="form-control", placeholder=form_security.current_password.label.text) }}
                                            {{ form_security.new_password(class="form-control", placeholder=form_security.new_password.label.text, id="new_password") }}
                                            {{ form_security.confirm_password(class="form-control", placeholder=form_security.confirm_password.label.text, id="confirm_password") }}
                                        </div>
                                        <a href="{{ url_for('professional.profile') }}" class="btn btn-secondary">Back</a>
                                        {{ form_security.submit(class="btn btn-primary", id="password_submit") }}
                                        <div id="error-message" style="color: red; margin-top: 5px; display: none"></div>
                                        <!-- Error message div -->
                                    </form>
                                    <hr />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <script>
                function previewImage(event) {
                    const imagePreview = document.getElementById("imagePreview");
                    const file = event.target.files[0];

                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            imagePreview.src = e.target.result;
                            imagePreview.style.display = "block"; // Show the uploaded image
                        };
                        reader.readAsDataURL(file);
                    } else {
                        imagePreview.src = "{{ url_for('static', filename='uploads/profile/' ~ current_user.profile_image) }}"; // Reset to current image
                        imagePreview.style.display = "block"; // Show current image
                    }
                }

                document.getElementById("profile_image").addEventListener("change", previewImage);
            </script>
            <script>
                document.addEventListener("DOMContentLoaded", function() {
                    const password = document.getElementById("new_password");
                    const confirmPassword = document.getElementById("confirm_password");
                    const submitButton = document.getElementById("password_submit");
                    const errorMessage = document.getElementById("error-message");

                    // Function to validate if the passwords match
                    function validatePasswords() {
                        if (password.value !== confirmPassword.value) {
                            errorMessage.textContent = "Passwords do not match";
                            errorMessage.style.display = "block";
                            submitButton.disabled = true; // Disable the submit button
                        } else {
                            errorMessage.style.display = "none"; // Hide error message
                            submitButton.disabled = false; // Enable the submit button
                        }
                    }

                    // Event listeners for both password fields
                    password.addEventListener("input", validatePasswords);
                    confirmPassword.addEventListener("input", validatePasswords);

                    // Prevent form submission if passwords don't match
                    document.getElementById("form_security").addEventListener("submit", function(e) {
                        if (password.value !== confirmPassword.value) {
                            e.preventDefault(); // Prevent default form submission
                            errorMessage.textContent = "Passwords do not match"; // Show error message
                            errorMessage.style.display = "block"; // Make the error message visible
                        }
                    });
                });
            </script>
        {% else %}
            <div class="container py-4 h-100">
                <div class="row d-flex justify-content-center align-items-top h-100">
                    <div class="col-md-4">
                        <div class="card shadow text-center mb-3 bg-dark text-white">
                            <div class="card-header bg-primary">
                                <h3>Profile Card</h3>
                            </div>
                            <div class="card-body">
                                <div class="d-flex flex-column align-items-center text-center">
                                    <img src="{{ url_for('static', filename='uploads/profile/' ~ professional['profile_image']) }}" alt="Profile Picture" class="rounded-circle" style="width: 100px; height: 100px; object-fit: cover" />
                                    <div class="mt-3">
                                        <h4>{{ professional['name'] }}</h4>
                                        <p class="mb-1">
                                            <i class="fas fa-envelope"></i> {{ professional['email'] }}
                                        </p>
                                        <p>
                                            <i class="fas fa-phone"></i> {{ professional['phone'] }}
                                        </p>
                                        <p>
                                            <span>
                                                <b class="badge bg-secondary">{{ professional['rating'] }}</b>
                                                {% for i in range(professional['rating'] | int) %}<i class="fas fa-star text-warning"></i>{% endfor %}
                                                {% for i in range(5-professional['rating'] | int) %}<i class="fas fa-star text-muted"></i>{% endfor %}
                                                <b class="badge bg-secondary"> {{(professional['total_reviews'])}} </b>
                                            </span>
                                        </p>
                                        <a class="btn btn-primary" target="_blank" href="{{ url_for('main.view_document', filename=professional['documents']) }}">View Document</a>
                                        
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card text-center shadow mb-3 bg-dark text-white">
                            <div class="card-header bg-primary">
                                <h3>Service Details</h3>
                            </div>
                            <div class="card-body">
                                <!-- Service Image -->
                                <div class="mb-4">
                                    <img src="{{ url_for('static', filename='images/' ~ professional_service['service_image']) }}" alt="Service Image" class="img-fluid rounded" style="max-width: 20%; height: auto" />
                                </div>
                                <h4 class="card-title">{{ professional_service['service_name'] }}</h4>
                                <!-- Service Price -->
                                <p class="card-text">
                                    <strong><i class="fas fa-tag"></i> Price: </strong> â‚¹{{ professional_service['service_price'] }}
                                </p>
                                <!-- Service Category -->
                                <p class="card-text">
                                    <strong><i class="fas fa-folder"></i> Category: </strong>{{ professional_service['service_category'] }}
                                </p>
                                <!-- Description -->
                                <p class="card-text">
                                    <strong><i class="fas fa-info-circle"></i> Description: </strong> {{ professional_service['service_description'] or 'No description available' }}
                                </p>
                            </div>
                        </div>
                        <div class="card text-white shadow mb-3 bg-dark">
                            <div class="card-header bg-primary">
                                <h3 class="text-center">Recent Reviews</h3>
                            </div>
                            
                            <div class="card-body d-flex flex-column">
                                {% if recent_reviews %}
                                    {% for review in recent_reviews %}
                                        <div class="d-flex mb-3">
                                            <div class="mr-3 text-center">
                                                <img src="{{ url_for('static', filename='uploads/profile/' ~ professional['profile_image']) }}" 
                                                     alt="Customer Picture" 
                                                     class="rounded-circle" 
                                                     style="width: 50px; height: 50px; object-fit: cover" />
                                            </div>
                                            <div class="flex">
                                                <div class="d-flex">
                                                    <a href="{{url_for('professional.customer', id=review['customer_id'])}}" style="text-decoration: none;"><strong>{{ review['customer_name'] }}</strong></a>
                                                </div>
                                                    <strong class="small text-muted">{{ review['date_created'] }}</strong>
                                               <br>
                                                <span>{{ review['description'] }}</span>
                                                <div>
                                                    <span>
                                                        {% for i in range(review['value'] | int) %}
                                                            <i class="fas fa-star text-warning"></i>
                                                        {% endfor %}
                                                        {% for i in range(5 - review['value'] | int) %}
                                                            <i class="fas fa-star text-muted"></i>
                                                        {% endfor %}
                                                    </span>
                                                    <span class="badge bg-warning text-dark">
                                                        {{ review['value'] }} / 5 <i class="fas fa-star"></i>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        <a href="{{url_for('professional.service_request', id=review['service_request_id'])}}" class="btn btn-primary">View</a>
                                        {% if not loop.last %}
                                            <div style="height: 1px; background-color: #6c757d; margin: 10px 0px;"></div> 
                                        {% endif %}

                                    {% endfor %}
                                {% else %}
                                    <p class="text-muted">No reviews available.</p>
                                {% endif %}
                            </div>
                            
                            
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="card shadow mb-3">
                            <div class="card-header bg-primary text-white">
                                <h3 class="text-center">Personal Information</h3>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-sm-3">
                                        <h6 class="mb-0">Full Name</h6>
                                    </div>
                                    <div class="col-sm-9 text-secondary">{{ professional['name'] }}</div>
                                </div>
                                <hr />
                                <div class="row">
                                    <div class="col-sm-3">
                                        <h6 class="mb-0">Email</h6>
                                    </div>
                                    <div class="col-sm-9 text-secondary">{{ professional['email'] }}</div>
                                </div>
                                <hr />
                                <div class="row">
                                    <div class="col-sm-3">
                                        <h6 class="mb-0">Phone</h6>
                                    </div>
                                    <div class="col-sm-9 text-secondary">{{ professional['phone'] }}</div>
                                </div>
                                <hr />
                                <div class="row">
                                    <div class="col-sm-3">
                                        <h6 class="mb-0">Address</h6>
                                    </div>
                                    <div class="col-sm-9 text-secondary">{{ professional['address'] }}</div>
                                </div>
                                <hr />
                                <div class="row">
                                    <div class="col-sm-3">
                                        <h6 class="mb-0">Pincode</h6>
                                    </div>
                                    <div class="col-sm-9 text-secondary">{{ professional['pincode'] }}</div>
                                </div>
                                <hr />
                                <div class="row">
                                    <div class="col-sm-3">
                                        <h6 class="mb-0">Experience</h6>
                                    </div>
                                    <div class="col-sm-9 text-secondary">{{ professional['experience'] }} years</div>
                                </div>
                                <hr />
                                <div class="row">
                                    <div class="col-sm-3">
                                        <h6 class="mb-0">Member since</h6>
                                    </div>
                                    <div class="col-sm-9 text-secondary">{{ professional['date_created'] }}</div>
                                </div>
                                <hr />
                                <div class="row">
                                    <div class="col-sm-12">
                                        <a class="btn btn-secondary" href="{{ url_for('professional.profile', edit=True) }}">Edit</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card shadow mb-3">
                            <div class="card-header bg-primary text-white">
                                <h3 class="text-center">Location</h3>
                            </div>
                            <div class="card-body">
                                {% if professional['latitude'] and professional['longitude'] %}
                                    <div class="row justify-content-center">
                                        <iframe src="https://www.openstreetmap.org/export/embed.html?bbox={{ professional['longitude'] }}%2C{{ professional['latitude'] }}%2C{{ professional['longitude'] }}%2C{{ professional['latitude'] }}&layer=mapnik&marker={{ professional['latitude'] }}%2C{{ professional['longitude'] }}" width="100%" height="400" style="border: 1px solid black" allowfullscreen>
                                        </iframe>
                                    </div>
                                    <small>
                                        <a href="https://www.openstreetmap.org/?mlat={{ professional['latitude'] }}&mlon={{ professional['longitude'] }}#map=16/{{ professional['latitude'] }}/{{ professional['longitude'] }}" target="_blank">View Larger Map</a>
                                    </small>
                                {% else %}
                                    <p class="text-muted">No Location Added.</p>
                                {% endif %}
                            </div>
                        </div>
                        <div class="card shadow mb-3">
                            <div class="card-header bg-primary text-white">
                                <h3 class="text-center">Recent Service Requests</h3>
                            </div>
                            <div class="card-body">
                                {% if recent_service_requests %}
                                    <ul class="list-group list-group-flush">
                                        {% for request in recent_service_requests %}
                                            <li class="list-group-item py-3">
                                                <div class="d-flex justify-content-between p-3 border rounded bg-light shadow-sm">
                                                    <div class="mt-2">
                                                        <span class="badge text-white {{ 'bg-success' if request['service_status'] == 'REQUESTED' else 'bg-secondary' if request['service_status'] == 'CLOSED' else 'bg-info' if request['service_status'] == 'ASSIGNED' else 'bg-danger' }}">{{ request['service_status'] }}</span>
                                                        <p class="small text-muted mb-1">
                                                            <i class="fa-regular fa-calendar"></i> Start From: <strong>{{ request['start_date'] }}</strong>
                                                            <br>
                                                        </p>
                                                        <p class="small text-muted mb-1">
                                                            <i class="fa-solid fa-money-bill"></i> Total Cost: <strong>Rs. {{ request['total_cost'] }}</strong>
                                                        </p>
                                                        <p class="mt-2">
                                                            <strong>Remarks:</strong> <span class="text-muted">{{ request['remarks'] or "No remarks provided." }}</span>
                                                        </p>
                                                    </div>
                                                    <div class="row align-items-end mr-2">
                                                        <a href="{{ url_for('professional.service_request', id=request['id']) }}" class="btn btn-secondary">View</a>
                                                    </div>
                                                </div>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <p class="text-muted">No service requests found.</p>
                                {% endif %}
                            </div>
                            <a href="{{url_for('professional.service_requests')}}" class="btn btn-secondary">View All</a>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    {% endif %}
{% endblock %}
